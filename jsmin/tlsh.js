(function(){function l(a,b,d,c){a=p[0^a];a=p[a^b];a=p[a^d];return a=p[a^c]}function n(a){return(a&240)>>4&15|(a&15)<<4&240}function q(a,b){for(var d=new String,c=0;c<b;c++)16>a[c]&&(d=d.concat("0")),d=d.concat(a[c].toString(16).toUpperCase());return d}function r(a,b,d){var c;b>a?(c=b-a,a=a+d-b):(c=a-b,a=b+d-a);return c>a?a:c}function v(a,b,d){var c=a.bucket_copy[b];a.bucket_copy[b]=a.bucket_copy[d];a.bucket_copy[d]=c}function t(a,b,d){if(b==d)return b;if(b+1==d)return a.bucket_copy[b]>a.bucket_copy[d]&&
v(a,b,d),b;var c=b,e=b+d>>1,f=a.bucket_copy[e];a.bucket_copy[e]=a.bucket_copy[d];for(a.bucket_copy[d]=f;b<d;b++)a.bucket_copy[b]<f&&(v(a,c,b),c++);a.bucket_copy[d]=a.bucket_copy[c];a.bucket_copy[c]=f;return c}var p=new Uint8Array([1,87,49,12,176,178,102,166,121,193,6,84,249,230,44,163,14,197,213,181,161,85,218,80,64,239,24,226,236,142,38,200,110,177,104,103,141,253,255,50,77,101,81,18,45,96,31,222,25,107,190,70,86,237,240,34,72,242,20,214,244,227,149,235,97,234,57,22,60,250,82,175,208,5,127,199,111,
62,135,248,174,169,211,58,66,154,106,195,245,171,17,187,182,179,0,243,132,56,148,75,128,133,158,100,130,126,91,13,153,246,216,219,119,68,223,78,83,88,201,99,122,11,92,32,136,114,52,10,138,30,48,183,156,35,61,26,143,74,251,94,129,162,63,152,170,7,115,167,241,206,3,150,55,59,151,220,90,53,23,131,125,173,15,238,79,95,89,16,105,137,225,224,217,160,37,123,118,73,2,157,46,116,9,145,134,228,207,212,202,215,69,229,27,188,67,124,168,252,42,4,29,108,21,247,19,205,39,203,233,40,186,147,198,192,155,33,164,191,
98,204,165,180,117,76,140,36,210,172,41,54,159,8,185,232,113,196,231,47,146,120,51,65,28,144,254,221,93,189,194,139,112,43,71,109,184,209]),w=function(){for(var a=Array(256),b=0;b<a.length;b++)a[b]=new Uint8Array(256);for(b=0;256>b;b++)for(var d=0;256>d;d++){var c=b,e=d,f,k=0;f=Math.abs(c%4-e%4);k+=3==f?6:f;c=Math.floor(c/4);e=Math.floor(e/4);f=Math.abs(c%4-e%4);k+=3==f?6:f;c=Math.floor(c/4);e=Math.floor(e/4);f=Math.abs(c%4-e%4);k+=3==f?6:f;c=Math.floor(c/4);e=Math.floor(e/4);f=Math.abs(c%4-e%4);
k+=3==f?6:f;a[b][d]=k}return a}();Tlsh=function(){this.checksum=new Uint8Array(1);this.slide_window=new Uint8Array(5);this.a_bucket=new Uint32Array(256);this.data_len=0;this.tmp_code=new Uint8Array(32);this.Q=this.Lvalue=0;this.lsh_code=new String;this.lsh_code_valid=!1};Tlsh.prototype.update=function(a,b){b="undefined"!==typeof b?b:a.length;for(var d=[],c=0;c<b;c++){var e=a.charCodeAt(c);if(255<e){alert("Unexpected "+a[c]+" has value "+e+" which is too large");return}d.push(e&255)}if(b!=d.length)alert("Unexpected string length:"+
b+" is not equal to value unsigned char length: "+d.length);else{a=this.data_len%5;e=this.data_len;for(c=0;c<b;c++,e++,a=(a+1+5)%5)if(this.slide_window[a]=d[c],4<=e){for(var f=(a-1+5)%5,k=(a-2+5)%5,u=(a-3+5)%5,g=(a-4+5)%5,h=0;1>h;h++)this.checksum[h]=0==h?l(0,this.slide_window[a],this.slide_window[f],this.checksum[h]):l(this.checksum[h-1],this.slide_window[a],this.slide_window[f],this.checksum[h]);l(2,this.slide_window[a],this.slide_window[f],this.slide_window[k]);l(2,this.slide_window[a],this.slide_window[f],
this.slide_window[k]);h=l(2,this.slide_window[a],this.slide_window[f],this.slide_window[k]);this.a_bucket[h]++;h=l(3,this.slide_window[a],this.slide_window[f],this.slide_window[u]);this.a_bucket[h]++;h=l(5,this.slide_window[a],this.slide_window[k],this.slide_window[u]);this.a_bucket[h]++;h=l(7,this.slide_window[a],this.slide_window[k],this.slide_window[g]);this.a_bucket[h]++;h=l(11,this.slide_window[a],this.slide_window[f],this.slide_window[g]);this.a_bucket[h]++;h=l(13,this.slide_window[a],this.slide_window[u],
this.slide_window[g]);this.a_bucket[h]++}this.data_len+=b}};Tlsh.prototype.finale=function(a,b){"undefined"!==typeof a&&this.update(a,b);256>this.data_len&&alert("ERROR: length too small - "+this.data_len);var d=a=0,c={};c.bucket_copy=new Uint32Array(128);for(var e=new Uint32Array(128),f=new Uint32Array(128),k=0,l=0,g=0;127>=g;g++)c.bucket_copy[g]=this.a_bucket[g];for(var h=0,m=127;;)if(g=t(c,h,m),63<g)m=g-1,f[l]=g,l++;else if(63>g)h=g+1,e[k]=g,k++;else{b=c.bucket_copy[63];break}e[k]=62;f[l]=64;for(h=
g=0;g<=k;g++)if(m=e[g],31<m){for(;;)if(g=t(c,h,m),31<g)m=g-1;else if(31>g)h=g+1;else{a=c.bucket_copy[31];break}break}else if(31>m)h=m;else{a=c.bucket_copy[31];break}g=0;for(m=127;g<=l;g++)if(h=f[g],95>h){for(;;)if(g=t(c,h,m),95<g)m=g-1;else if(95>g)h=g+1;else{d=c.bucket_copy[95];break}break}else if(95<h)m=h;else{d=c.bucket_copy[95];break}for(c=f=0;32>c;c++)for(e=0;4>e;e++)0<this.a_bucket[4*c+e]&&f++;64>=f&&alert("ERROR: not enought variation in input - "+f+" < 64");for(c=0;32>c;c++){for(e=f=0;4>e;e++)k=
this.a_bucket[4*c+e],d<k?f+=3<<2*e:b<k?f+=2<<2*e:a<k&&(f+=1<<2*e);this.tmp_code[c]=f}c=this.data_len;this.Lvalue=(656>=c?Math.floor(Math.log(c)/.4054651):3199>=c?Math.floor(Math.log(c)/.26236426-8.72777):Math.floor(Math.log(c)/.09531018-62.5472))&255;this.Q=this.Q&240|100*a/d%16&15;this.Q=this.Q&15|(100*b/d%16&15)<<4;this.lsh_code_valid=!0};Tlsh.prototype.hash=function(){if(0==this.lsh_code_valid)return"ERROR IN PROCESSING";var a,b,d,c;a=new Uint8Array(1);c=new Uint8Array(32);for(b=0;1>b;b++)a[b]=
n(this.checksum[b]);b=n(this.Lvalue);d=n(this.Q);for(var e=0;32>e;e++)c[e]=this.tmp_code[31-e];this.lsh_code=q(a,1);tmpArray=new Uint8Array(1);tmpArray[0]=b;this.lsh_code=this.lsh_code.concat(q(tmpArray,1));tmpArray[0]=d;this.lsh_code=this.lsh_code.concat(q(tmpArray,1));return this.lsh_code=this.lsh_code.concat(q(c,32))};Tlsh.prototype.reset=function(){this.checksum=new Uint8Array(1);this.slide_window=new Uint8Array(5);this.a_bucket=new Uint32Array(256);this.data_len=0;this.tmp_code=new Uint8Array(32);
this.Q=this.Lvalue=0;this.lsh_code=new String;this.lsh_code_valid=!1};Tlsh.prototype.totalDiff=function(a,b){if(this==a)return 0;var d=0;if("undefined"!==typeof b?b:1)b=r(this.Lvalue,a.Lvalue,256),d=0==b?0:1==b?1:d+12*b;b=r(this.Q&15,a.Q&15,16);d=1>=b?d+b:d+12*(b-1);b=r((this.Q&240)>>4,(a.Q&240)>>4,16);d=1>=b?d+b:d+12*(b-1);for(b=0;1>b;b++)if(this.checksum[b]!=a.checksum[b]){d++;break}b=this.tmp_code;a=a.tmp_code;for(var c=0,e=0;32>e;e++)c+=w[b[e]][a[e]];return d+=c};Tlsh.prototype.fromTlshStr=function(a){if(70!=
a.length)alert("Tlsh.fromTlshStr() - string has wrong length ("+a.length+" != 70)");else{for(var b=0;70>b;b++)if(!("0"<=a[b]&&"9">=a[b]||"A"<=a[b]&&"F">=a[b]||"a"<=a[b]&&"f">=a[b])){alert("Tlsh.fromTlshStr() - string has invalid (non-hex) characters");return}for(var d=new Uint8Array(a.length/2),b=0;b<a.length;b+=2)d[b/2]=parseInt(a.substring(b,b+2),16);b=0;this.checksum[b]=n(d[b++]);this.Lvalue=n(d[b++]);this.Q=n(d[b++]);for(a=0;32>a;a++)this.tmp_code[a]=d[b+32-1-a];this.lsh_code_valid=!0}}})(this);
